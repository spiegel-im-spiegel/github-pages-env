+++
title = "Java 製 Logger “Log4j” の脆弱性について"
date =  "2021-12-11T15:22:43+09:00"
description = "2.15.0 以降にアップデートするか何らかの緩和措置を行うこと。"
image = "/images/attention/kitten.jpg"
tags  = [ "java", "security", "vulnerability", "logger" ]
pageType = "text"

[scripts]
  mathjax = false
  mermaidjs = false
+++

私の Twitter TL では昨日あたりからちらほら見かけるようになったが Java 製の事実上の標準 logger である Apache Log4j パッケージに脆弱性があったそうで，最新版 [2.15.0](https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.15.0) のアナウンスが出ている。
ちょっと大事になりそうな気がするので，この記事で覚え書きとして残しておく。

## [CVE-2021-44228]

{{< fig-quote type="markdown" title="Log4j – Apache Log4j Security Vulnerabilities" link="https://logging.apache.org/log4j/2.x/security.html" lang="en" >}}
{{% quote %}}Apache Log4j2 <=2.14.1 JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled. From log4j 2.15.0, this behavior has been disabled by default{{% /quote %}}.
{{< /fig-quote >}}

ちょっと分かりにくいかもしれないので，以下の解説記事も参考にどうぞ。

{{< fig-quote type="markdown" title="log4jの脆弱性について" link="https://ezoeryou.github.io/blog/article/2021-12-10-log4j.html" >}}
今回問題となっているのはJndi Lookupだ。これはJavaのJava Naming and Directory Interfaceによる変数名の置換で、ネットワーク越しに変数に相当する値を検索することができる。その中にLDAPも含まれる。例えば`"${jndi:ldap://someremoteclass}"`のようになる。

問題は、このURLに.を含めることにより、lg4jは任意のリモートのLDAPサーバーからjava classファイルをダウンロードして読み込んでしまうのだ。

なので悪意あるjava classファイルとそれをホストするLDAPサーバーを用意して、ターゲットとなるJavaで動きlog4jを使っているプログラムに`"${jndi:ldap://URL}"`の形でログ出力されるようにすれば、任意のコード実行が可能になる。
{{< /fig-quote >}}

ここまで言及されれば今回の脆弱性のヤバさが分かるだろう。
サービス側にログが吐かれるだけでこの脆弱性が発火する可能性があるのだ。
これは私達が目にしている各種サービスだけではなく，たとえばバックエンドで外部の Web API サービスを利用しているのならそちらも考慮する必要がある。
あるいは，もしかしたら組込み製品でアプリケーションを Java で組んでいるかもしれない。

Apache Log4j はこの脆弱性の CVSS 評価値を

- `CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H`
- 深刻度: 緊急 (Score: 10)

| 基本評価基準 | 評価値 |
|--------|-------|
| 攻撃元区分 | ネットワーク |
| 攻撃条件の複雑さ | 低 |
| 必要な特権レベル | 不要 |
| ユーザ関与レベル | 不要 |
| スコープ | 変更あり |
| 機密性への影響 | 高 |
| 完全性への影響 | 高 |
| 可用性への影響 | 高 |

と見積もっている。

一応，サービス側の緩和措置も示されているので「すぐに対応できないよー」という場合は参考にするといいだろう。

{{< fig-quote type="markdown" title="Log4j – Apache Log4j Security Vulnerabilities" link="https://logging.apache.org/log4j/2.x/security.html" lang="en" >}}
{{% quote %}}In releases >=2.10, this behavior can be mitigated by setting either the system property `log4j2.formatMsgNoLookups` or the environment variable `LOG4J_FORMAT_MSG_NO_LOOKUPS` to `true`. For releases from 2.0-beta9 to 2.10.0, the mitigation is to remove the `JndiLookup` class from the classpath: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`{{% /quote %}}.
{{< /fig-quote >}}

とりあえずシステム・プロパティまたは環境変数で対応って感じかねぇ。

アップデートは計画的に。

## ブックマーク

- [GitHub - apache/logging-log4j2: Apache Log4j 2 is an upgrade to Log4j that provides significant improvements over its predecessor, Log4j 1.x, and provides many of the improvements available in Logback while fixing some inherent problems in Logback's architecture.](https://github.com/apache/logging-log4j2)
- [Remote code injection in Log4j · CVE-2021-44228 · GitHub Advisory Database · GitHub](https://github.com/advisories/GHSA-jfh8-c2jp-5v3q)
- [Oracle Security Alert Advisory - CVE-2021-44228](https://www.oracle.com/security-alerts/alert-cve-2021-44228.html)
- [“Log4Shell” Java vulnerability – how to safeguard your servers – Naked Security](https://nakedsecurity.sophos.com/2021/12/10/log4shell-java-vulnerability-how-to-safeguard-your-servers/)
- [Log4shell software flaw threatens millions of servers as hackers scramble to exploit it - ABC News](https://www.abc.net.au/news/2021-12-11/log4shell-techs-race-to-fix-software-flaw/100692876)
- [Apache Log4j2 Security Bulletin (CVE-2021-44228)](https://aws.amazon.com/security/security-bulletins/AWS-2021-005/)
- [Cybereason/Logout4Shell: Use Log4Shell vulnerability to vaccinate a victim server against Log4Shell](https://github.com/Cybereason/Logout4Shell)
- [RCE in log4j, Log4Shell, or how things can get bad quickly](https://isc.sans.edu/forums/diary/28120/)
- [Apache Log4jの任意のコード実行の脆弱性（CVE-2021-44228）に関する注意喚起](https://www.jpcert.or.jp/at/2021/at210050.html)
- [マイクラもハッキング ～「Apache Log4j」ライブラリに致命的なリモートコード実行のゼロデイ脆弱性【12月10日18:45追記】 - やじうまの杜 - 窓の杜](https://forest.watch.impress.co.jp/docs/serial/yajiuma/1373242.html)

Minecraft では既に影響が出ている模様：

{{< fig-gen >}}
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Critical RCE exploit discovered on all Minecraft <br> Java versions from 1.7 to 1.18, clients and servers. (Log4j2 2.0.0 - 2.14.1 vuln)<br>Fix it w:<br>- Use -Dlog4j2.formatMsgNoLookups=true<br>- Update Fabric Loader to 0.12.9<br>- Upgrade Paper server to latest 1.18 <br>- Wait for mojang patches</p>&mdash; Minecraft@Home (@minecraftathome) <a href="https://twitter.com/minecraftathome/status/1469110749431803904?ref_src=twsrc%5Etfw">December 10, 2021</a></blockquote>
{{< /fig-gen >}}

- [Worst Apache Log4j RCE Zero day Dropped on Internet - Cyber Kendra](https://www.cyberkendra.com/2021/12/worst-log4j-rce-zeroday-dropped-on.html)
- [Log4Shell: RCE 0-day exploit found in log4j2, a popular Java logging package | LunaSec](https://www.lunasec.io/docs/blog/log4j-zero-day/) : Steam や iCloud も対象なのか

[CVE-2021-44228]: https://nvd.nist.gov/vuln/detail/CVE-2021-44228

## 参考図書

{{% review-paapi "B07CKHR8C1" %}} <!-- Spring Data JPAプログラミング入門 -->
{{% review-paapi "4621303252" %}} <!-- Effective Java 第3版 -->
{{% review-paapi "B0893LQ5KY" %}} <!-- Spring Boot 2 入門 -->
{{% review-paapi "B09HK66P5X" %}} <!-- Java言語で学ぶデザインパターン入門第3版 -->
