+++
date = "2015-11-18T20:29:21+09:00"
update = "2015-11-19T11:30:40+09:00"
description = "なお，今回のケースは Java 以外にも広がるかもしれないので，類似情報に注意しておいた方がいいだろう。"
draft = false
tags = ["security", "vulnerability", "de-serialize", "java"]
title = "Apache Commons Collections ライブラリの非直列化処理に脆弱性"

[author]
  avatar = "/images/avatar.jpg"
  facebook = "spiegel.im.spiegel"
  flattr = "spiegel"
  github = "spiegel-im-spiegel"
  instagram = "spiegel_2007"
  license = "by-sa"
  linkedin = "spiegelimspiegel"
  medium = "@spiegel"
  name = "Spiegel"
  twitter = "spiegel_2007"
  url = "http://www.baldanders.info/spiegel/profile/"
+++

1週間以上前の話で，なんだか今更なんだけど，全く仕事に絡んでないこともないので，覚え書きの形で残しておく。
なお，今回のケースは Java 以外にも広がるかもしれないので，類似情報に注意しておいた方がいいだろう。

## 脆弱性の内容

発端はこれ。

{{< fig-quote title="Apache Commons Collections ライブラリのデシリアライズ処理に脆弱性" link="http://jvn.jp/vu/JVNVU94276522/" >}}
<q>2015年1月に開催された AppSec California 2015 において、<a href="http://frohoff.github.io/appseccali-marshalling-pickles/">Gabriel Lawrence 氏と Chris Frohoff 氏</a>は、信頼できないデータをデシリアライズしてしまう脆弱性について講演し、任意のコードを実行可能であることを示しました。</q>
{{< /fig-quote >}}

{{< fig-slideshare id="a8ysJs2aqxHie8" height="422" width="514" title="AppSecCali 2015 - Marshalling Pickles" link="http://www.slideshare.net/frohoff1/appseccali-2015-marshalling-pickles" >}}

この際に [PoC]（Proof-of-Concept; 概念実証コード）も公開されている。

更に両氏は今月になって，この [PoC] を使って Apache Commons Collections ライブラリを使用するいくつかのミドルウェアおよび Groovy, Spring が攻略可能であることを示した。

## 影響を受ける製品

- Apache Commons Collections ライブラリのバージョン 3.2.1 および 4.0
- Groovy や Spring の一部バージョン
- 上記ライブラリまたはフレームワークが classpath に読み込まれている状態で，シリアル化された Java オブジェクトを外部から受け付けている環境
    - WebLogic, WebSphere, JBoss, Jenkins, OpenNMS 等のミドルウェア製品

{{< fig-quote title="主要Javaアプリケーションサーバに影響するJavaライブラリの脆弱性を正しく理解する" link="http://blog.trendmicro.co.jp/archives/12577" >}}
<q>Weblogic や WebSphere に対して可能だと言われているのは、アプリケーションサーバを起動または停止するために通常、組織内で使用する管理ポートへの攻撃です。これらのアプリケーションサーバ上で稼働するすべての Webアプリケーションに影響があるわけではありません。受け付ける入力にシリアル化された Javaオブジェクトを含まない、つまり入力がユーザーのマウス操作やキー入力、文字データや画像のみであるような Webアプリケーションであれば影響を受けません。</q>
{{< /fig-quote >}}

さらに

- Java 以外にも Python, Ruby などで書かれたアプリケーションやライブラリにも同様の脆弱性がある可能性が指摘されている
    - [Rails 3.2.10 Remote Code Execution](https://github.com/charliesome/charlie.bz/blob/master/posts/rails-3.2.10-remote-code-execution.md "charlie.bz/rails-3.2.10-remote-code-execution.md at master · charliesome/charlie.bz")

### 影響度（CVSSv2）

CVSS 基本評価値 7.5 (AV:N/AC:L/Au:N/C:P/I:P/A:P)

| 基本評価基準                            | 評価値            |
|----------------------------------------:|:------------------|
| 攻撃元区分（AV）                        | ネットワーク（N） |
| 攻撃条件の複雑さ（AC）                  | 低 (L)            |
| 攻撃前の認証要否（Au）                  | 不要（N）[^a]     |
| 情報漏えいの可能性（機密性への影響, C） | 部分的（P）       |
| 情報改ざんの可能性（完全性への影響, I） | 部分的（P）       |
| 業務停止の可能性（可用性への影響, A）   | 部分的（P）       |

[^a]: [PoC] による攻撃に限るなら認証をバイパスできないため，外部入力に認証をかけている場合は評価値は7未満になる。今回のようなケースは CVSSv2 では評価が難しいかも。 [CVSSv3](http://www.baldanders.info/spiegel/log2/000864.shtml) で評価し直した方がいいかな。

CVSS については[デモページ](http://www.baldanders.info/spiegel/archive/cvss/cvss2.html)を参照のこと。

## 対策・回避策

回避策としては以下のとおり。

- 外部入力に認証をかける（今回の [PoC] には認証をバイパスする機能はない）
- 外部入力にシリアル化された Java オブジェクトを受け付けない，または受け付けるオブジェクトを限定する
- [PoC] 対象のクラス（ACC ライブラリであれば `InvokerTransformer` クラス）を使用しない。

さらに根本的な対策としてアプリケーションの設計の見直しが推奨されている。

{{< fig-quote title="Apache Commons statement to widespread Java object de-serialisation vulnerability" link="https://blogs.apache.org/foundation/entry/apache_commons_statement_to_widespread" lang="en" >}}
<q>However, to be clear: this is not the only known and especially not unknown useable gadget. So replacing your installations with a hardened version of Apache Commons Collections will not make your application resist this vulnerability.</q>
{{< /fig-quote >}}

{{< fig-quote title="Apache Commons Collections ライブラリのデシリアライズ処理に脆弱性" link="http://jvn.jp/vu/JVNVU94276522/" >}}
<q>Apache Commons Collections ライブラリの対策版リリースの準備が進められています。しかし、現状提案されているパッチはシリアライズ機能をデフォルトで無効にするだけのものです。当該ライブラリのシリアライズ機能が必要な場合には、この機能を有効にするコードを追加するとともに、安全にデシリアライズするようアプリケーションの設計を見直す必要があります。</q>
{{< /fig-quote >}}

{{< fig-quote title="主要Javaアプリケーションサーバに影響するJavaライブラリの脆弱性を正しく理解する" link="http://blog.trendmicro.co.jp/archives/12577" >}}
<q>この PoC が公開された「<a href="http://frohoff.github.io/appseccali-marshalling-pickles/">Marshalling Pickles</a>」の発表には「オブジェクトのデシリアル化処理はいかにしてあなたの一日を台無しにするか」という副題がついており、Java に限らずシリアル化されたオブジェクトを受け取り、デシリアル化処理を行う場合の危険性について広く述べられています。<br>
なかでも強く「脆弱性は非安全なデシリアル化処理にあるのであり、PoC があることが脆弱なのではない」と述べられています。デシリアル化処理には脆弱性ができやすいため、これを安全に行うための方法として、デシリアル化するクラスをホワイトリストでフィルターする（resolveClass のオーバーライド）、単なる暗号化ではない適切な認証方法を利用することなどが紹介されています。</q>
{{< /fig-quote >}}

### ベンダの対応

- WebLogic : [回避策](https://support.oracle.com/rs?type=doc&id=2076338.1)あり（パッチ準備中）
- WebSphere : 最新版あり
- JBoss : 最新版あり（一部パッチ準備中），危険なクラスを削除
- Jenkins : 最新版あり
- OpenNMS : Port 1099 の遮断で回避
- Groovy : 最新版あり
- Spring : 最新版あり

## 参考

- [JVNVU#94276522: Apache Commons Collections ライブラリのデシリアライズ処理に脆弱性](http://jvn.jp/vu/JVNVU94276522/)
- [Vulnerability Note VU#576313 - Apache Commons Collections Java library insecurely deserializes data](http://www.kb.cert.org/vuls/id/576313)
- [AppSecCali 2015: Marshalling Pickles by frohoff](http://frohoff.github.io/appseccali-marshalling-pickles/)
    - [frohoff/ysoserial](https://github.com/frohoff/ysoserial) : 概念実証コード
- [What Do WebLogic, WebSphere, JBoss, Jenkins, OpenNMS, and Your Application Have in Common? This Vulnerability.](http://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
- [Apache Commons statement to widespread Java object de-serialisation vulnerability : The Apache Software Foundation Blog](https://blogs.apache.org/foundation/entry/apache_commons_statement_to_widespread)
- [主要Javaアプリケーションサーバに影響するJavaライブラリの脆弱性を正しく理解する | トレンドマイクロ セキュリティブログ](http://blog.trendmicro.co.jp/archives/12577)
- [Javaライブラリに脆弱性、主要ミドルウェア全てに影響 - ITmedia エンタープライズ](http://www.itmedia.co.jp/enterprise/articles/1511/10/news053.html)
- [Javaライブラリにリモートコード実行の脆弱性--JBoss、WebSphere、WebLogicなどに影響 - ZDNet Japan](http://japan.zdnet.com/article/35073223/)
- [Apache Commonsのcollectionsの脆弱性に関連するリンク集をまとめてみた。 - piyolog](http://d.hatena.ne.jp/Kango/20151110/1447175137)
- [commons-collectionsのInvokerTransformer脆弱性について - R42日記](http://takahashikzn.root42.jp/entry/2015/11/10/155319)
- [SpringとGroovyにも直列化オブジェクト脆弱性 - R42日記](http://takahashikzn.root42.jp/entry/2015/11/12/031449)

[PoC]: https://github.com/frohoff/ysoserial "frohoff/ysoserial"
