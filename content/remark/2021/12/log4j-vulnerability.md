+++
title = "Java 製 Logger “Log4j” の脆弱性について"
date =  "2021-12-11T15:22:43+09:00"
description = "Logback にも脆弱性（の可能性）あり。"
image = "/images/attention/kitten.jpg"
tags  = [ "java", "security", "vulnerability", "logger" ]
pageType = "text"

[scripts]
  mathjax = false
  mermaidjs = false
+++

私の Twitter TL では 2021-12-10 あたりからちらほら見かけるようになったが Java 製の事実上の標準 logger である Apache Log4j に脆弱性があったそうで，最新版 [2.15.0](https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.15.0) のアナウンスが出ている。
ちょっと大事になりそうな気がするので，この記事で覚え書きとして残しておく。

## [CVE-2021-44228]

{{< fig-quote type="markdown" title="Log4j – Apache Log4j Security Vulnerabilities" link="https://logging.apache.org/log4j/2.x/security.html" lang="en" >}}
{{% quote %}}Apache Log4j2 <=2.14.1 JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled. From log4j 2.15.0, this behavior has been disabled by default{{% /quote %}}.
{{< /fig-quote >}}

ちょっと分かりにくいかもしれないので，以下の解説記事も参考にどうぞ。

{{< fig-quote type="markdown" title="log4jの脆弱性について" link="https://ezoeryou.github.io/blog/article/2021-12-10-log4j.html" >}}
今回問題となっているのはJndi Lookupだ。これはJavaのJava Naming and Directory Interfaceによる変数名の置換で、ネットワーク越しに変数に相当する値を検索することができる。その中にLDAPも含まれる。例えば`"${jndi:ldap://someremoteclass}"`のようになる。

問題は、このURLに.を含めることにより、lg4jは任意のリモートのLDAPサーバーからjava classファイルをダウンロードして読み込んでしまうのだ。

なので悪意あるjava classファイルとそれをホストするLDAPサーバーを用意して、ターゲットとなるJavaで動きlog4jを使っているプログラムに`"${jndi:ldap://URL}"`の形でログ出力されるようにすれば、任意のコード実行が可能になる。
{{< /fig-quote >}}

ここまで言及されれば今回の脆弱性のヤバさが分かるだろう。
サービス側にログが吐かれるだけでこの脆弱性が発火する可能性があるのだ。
これは私達が目にしている各種サービスだけではなく，たとえばバックエンドで外部の Web API サービスを利用しているのならそちらも考慮する必要がある。
あるいは，もしかしたら組込み製品でアプリケーションを Java で組んでいるかもしれない。

Apache Log4j はこの脆弱性の CVSS 評価値を

- `CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H`
- 深刻度: 緊急 (Score: 10)

| 基本評価基準 | 評価値 |
|--------|-------|
| 攻撃元区分 | ネットワーク |
| 攻撃条件の複雑さ | 低 |
| 必要な特権レベル | 不要 |
| ユーザ関与レベル | 不要 |
| スコープ | 変更あり |
| 機密性への影響 | 高 |
| 完全性への影響 | 高 |
| 可用性への影響 | 高 |

と見積もっている。

一応，サービス側の緩和措置も示されているので「すぐに対応できないよー」という場合は参考にするといいだろう。

{{< fig-quote type="markdown" title="Log4j – Apache Log4j Security Vulnerabilities" link="https://logging.apache.org/log4j/2.x/security.html" lang="en" >}}
{{% quote %}}In releases >=2.10, this behavior can be mitigated by setting either the system property `log4j2.formatMsgNoLookups` or the environment variable `LOG4J_FORMAT_MSG_NO_LOOKUPS` to `true`. For releases from 2.0-beta9 to 2.10.0, the mitigation is to remove the `JndiLookup` class from the classpath: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`{{% /quote %}}.
{{< /fig-quote >}}

とりあえずシステム・プロパティまたは環境変数で対応って感じかねぇ。

アップデートは計画的に。

## 【2021-12-15 追記】 [CVE-2021-44228]

リリースした [2.15.0](https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.15.0) に不備があったため [2.16.0](https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.16.0) がリリースされている。

{{< fig-quote type="markdown" title="Log4j – Apache Log4j Security Vulnerabilities" link="https://logging.apache.org/log4j/2.x/security.html" lang="en" >}}
{{% quote %}}It was found that the fix to address CVE-2021-44228 in Apache Log4j 2.15.0 was incomplete in certain non-default configurations. This could allows attackers with control over Thread Context Map (MDC) input data when the logging configuration uses a non-default Pattern Layout with either a Context Lookup (for example, `$${ctx:loginId}`) or a Thread Context Map pattern (`%X`, `%mdc`, or `%MDC`) to craft malicious input data using a JNDI Lookup pattern resulting in a denial of service (DOS) attack. Log4j 2.15.0 restricts JNDI LDAP lookups to localhost by default. Note that previous mitigations involving configuration such as to set the system property `log4j2.noFormatMsgLookup` to true do NOT mitigate this specific vulnerability{{% /quote %}}.
{{< /fig-quote >}}

Apache Log4j はこの脆弱性の CVSS 評価値を

- `CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:C/C:H/I:H/A:H`<br>(`CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:L` から大幅に引き上げた模様【2021-12-18 追記】)
- 深刻度: 緊急 (Score: 9)

| 基本評価基準 | 評価値 |
|--------|-------|
| 攻撃元区分 | ネットワーク |
| 攻撃条件の複雑さ | 高 |
| 必要な特権レベル | 不要 |
| ユーザ関与レベル | 不要 |
| スコープ | 変更あり |
| 機密性への影響 | 高 |
| 完全性への影響 | 高 |
| 可用性への影響 | 高 |

と見積もっている。

前節で示した緩和策は使えないらしい。
2.16.0 以降に上げられないのであれば

{{< fig-quote type="markdown" title="Log4j – Apache Log4j Security Vulnerabilities" link="https://logging.apache.org/log4j/2.x/security.html" lang="en" >}}
{{% quote %}}Otherwise, remove the `JndiLookup` class from the classpath: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`{{% /quote %}}
{{< /fig-quote >}}

と class ファイルを削除する必要がある。

## 【2021-12-20 追記】 [CVE-2021-45105]

先日リリースされた [2.16.0](https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.16.0) には以下の脆弱性があり，これを緩和する [2.17.0](https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.17.0) がリリースされた。

{{< fig-quote type="markdown" title="Log4j – Apache Log4j Security Vulnerabilities" link="https://logging.apache.org/log4j/2.x/security.html" lang="en" >}}
{{% quote %}}Apache Log4j2 versions 2.0-alpha1 through 2.16.0 did not protect from uncontrolled recursion from self-referential lookups. When the logging configuration uses a non-default Pattern Layout with a Context Lookup (for example, `$${ctx:loginId}`), attackers with control over Thread Context Map (MDC) input data can craft malicious input data that contains a recursive lookup, resulting in a StackOverflowError that will terminate the process. This is also known as a DOS (Denial of Service) attack{{% /quote %}}.
{{< /fig-quote >}}

Apache Log4j はこの脆弱性の CVSS 評価値を

- `CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H`
- 深刻度: 重要 (Score: 7.5)

| 基本評価基準 | 評価値 |
|--------|-------|
| 攻撃元区分 | ネットワーク |
| 攻撃条件の複雑さ | 低 |
| 必要な特権レベル | 不要 |
| ユーザ関与レベル | 不要 |
| スコープ | 変更なし |
| 機密性への影響 | なし |
| 完全性への影響 | なし |
| 可用性への影響 | 高 |

と見積もっている。


また別の緩和手順として

{{< fig-quote type="markdown" title="Log4j – Apache Log4j Security Vulnerabilities" link="https://logging.apache.org/log4j/2.x/security.html" lang="en" >}}
- In PatternLayout in the logging configuration, replace Context Lookups like `${ctx:loginId}` or `$${ctx:loginId}` with Thread Context Map patterns (`%X`, `%mdc`, or `%MDC`).
- Otherwise, in the configuration, remove references to Context Lookups like `${ctx:loginId}` or `$${ctx:loginId}` where they originate from sources external to the application such as HTTP headers or user input.
{{< /fig-quote >}}

を挙げている。

## 【2021-12-15 追記】 Logback にも脆弱性（の可能性）あり

[Logback] バージョン 1.2.8 が[リリース](http://logback.qos.ch/news.html)されている。
このバージョンでは [LOGBACK-1591](https://jira.qos.ch/browse/LOGBACK-1591) に絡む対応が行われている。
ただし，これが脆弱性として発火するとしても以下の前提条件が必要となる。

{{< fig-quote type="markdown" title="News" link="http://logback.qos.ch/news.html" lang="en" >}}
1. write access to `logback.xml`
1. use of versions < 1.2.8
1. reloading of poisoned configuration data, which implies application restart or `scan="true"` set prior to attack
{{< /fig-quote >}}

[LOGBACK-1591](https://jira.qos.ch/browse/LOGBACK-1591) は現時点（2021-12-15）ではまだ確定的ではないが，予防措置として log4j と同じく JNDI lookup コードを削除することにしたようだ。

## ブックマーク

- [GitHub - apache/logging-log4j2: Apache Log4j 2 is an upgrade to Log4j that provides significant improvements over its predecessor, Log4j 1.x, and provides many of the improvements available in Logback while fixing some inherent problems in Logback's architecture.](https://github.com/apache/logging-log4j2)
- [Remote code injection in Log4j · CVE-2021-44228 · GitHub Advisory Database · GitHub](https://github.com/advisories/GHSA-jfh8-c2jp-5v3q)
- [Oracle Security Alert Advisory - CVE-2021-44228](https://www.oracle.com/security-alerts/alert-cve-2021-44228.html)
- [“Log4Shell” Java vulnerability – how to safeguard your servers – Naked Security](https://nakedsecurity.sophos.com/2021/12/10/log4shell-java-vulnerability-how-to-safeguard-your-servers/)
- [Log4shell software flaw threatens millions of servers as hackers scramble to exploit it - ABC News](https://www.abc.net.au/news/2021-12-11/log4shell-techs-race-to-fix-software-flaw/100692876)
- [Apache Log4j2 Security Bulletin (CVE-2021-44228)](https://aws.amazon.com/security/security-bulletins/AWS-2021-005/)
- [Cybereason/Logout4Shell: Use Log4Shell vulnerability to vaccinate a victim server against Log4Shell](https://github.com/Cybereason/Logout4Shell)
- [RCE in log4j, Log4Shell, or how things can get bad quickly](https://isc.sans.edu/forums/diary/28120/)
- [Apache Log4j の脆弱性対策について(CVE-2021-44228)：IPA 独立行政法人 情報処理推進機構](https://www.ipa.go.jp/security/ciadr/vul/alert20211213.html)
  - [Apache Log4jの任意のコード実行の脆弱性（CVE-2021-44228）に関する注意喚起](https://www.jpcert.or.jp/at/2021/at210050.html)
- [マイクラもハッキング ～「Apache Log4j」ライブラリに致命的なリモートコード実行のゼロデイ脆弱性【12月10日18:45追記】 - やじうまの杜 - 窓の杜](https://forest.watch.impress.co.jp/docs/serial/yajiuma/1373242.html)

Minecraft では既に影響が出ている模様：

{{< fig-gen >}}
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Critical RCE exploit discovered on all Minecraft <br> Java versions from 1.7 to 1.18, clients and servers. (Log4j2 2.0.0 - 2.14.1 vuln)<br>Fix it w:<br>- Use -Dlog4j2.formatMsgNoLookups=true<br>- Update Fabric Loader to 0.12.9<br>- Upgrade Paper server to latest 1.18 <br>- Wait for mojang patches</p>&mdash; Minecraft@Home (@minecraftathome) <a href="https://twitter.com/minecraftathome/status/1469110749431803904?ref_src=twsrc%5Etfw">December 10, 2021</a></blockquote>
{{< /fig-gen >}}

- [Worst Apache Log4j RCE Zero day Dropped on Internet - Cyber Kendra](https://www.cyberkendra.com/2021/12/worst-log4j-rce-zeroday-dropped-on.html)
- [Log4Shell: RCE 0-day exploit found in log4j2, a popular Java logging package | LunaSec](https://www.lunasec.io/docs/blog/log4j-zero-day/) : Steam や iCloud も対象なのか
- [Apache Log4j 2 CVE-2021-44228 - Docker Blog](https://www.docker.com/blog/apache-log4j-2-cve-2021-44228/) : “Docker Official Images” で今回の脆弱性の影響を受けるものがリストアップされている
- [Inside the Log4j2 vulnerability (CVE-2021-44228)](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
- [What you need to know about the Log4J vulnerability rocking the internet - F-Secure Blog](https://blog.f-secure.com/what-you-need-to-know-about-the-log4j-vulnerability-rocking-the-internet/)
- [Microsoft’s Response to CVE-2021-44228 Apache Log4j 2 – Microsoft Security Response Center](https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/)
- [Statement from CISA Director Easterly on “Log4j” Vulnerability | CISA](https://www.cisa.gov/news/2021/12/11/statement-cisa-director-easterly-log4j-vulnerability)
- [The Log4J Vulnerability Will Haunt the Internet for Years | WIRED](https://www.wired.com/story/log4j-log4shell/)
  - [On the Log4j Vulnerability - Schneier on Security](https://www.schneier.com/blog/archives/2021/12/on-the-log4j-vulnerability.html)
- [Log4jの深刻な脆弱性CVE-2021-44228についてまとめてみた - piyolog](https://piyolog.hatenadiary.jp/entry/2021/12/13/045541)
- [「Docker Desktop」が「Log4j」問題に対応 ～脆弱性スキャンツールを更新 - 窓の杜](https://forest.watch.impress.co.jp/docs/news/1373550.html)
- [iCloud、ツイッター、マインクラフトなどに使われているオープンソースのログユーティリティにゼロデイ脆弱性が見つかる  |  TechCrunch Japan](https://techcrunch.com/2021/12/10/apple-icloud-twitter-and-minecraft-vulnerable-to-ubiquitous-zero-day-exploit/)
- [広く使われているJavaライブラリ「Log4j」に深刻な脆弱性。速やかに確認と対策を － Publickey](https://www.publickey1.jp/blog/21/javalog4j.html)
- [【注意喚起】Log4jの脆弱性を狙う攻撃を多数検知、至急対策を！ | セキュリティ対策のラック](https://www.lac.co.jp/lacwatch/alert/20211213_002820.html)
- [システムの重要な基盤「Log4j」の脆弱性が、世界中に“破壊的”な影響を及ぼしている | WIRED.jp](https://wired.jp/2021/12/12/log4j-flaw-hacking-internet/)
- [LOG4J2-3211 - Remove Messge Lookups (#623) · apache/logging-log4j2@2797204 · GitHub](https://github.com/apache/logging-log4j2/commit/27972043b76c9645476f561c5adc483dec6d3f5d) : 2.16.0 登場。メッセージ・ルックアップ機能をコードから削除した模様
- [Log4j 2のバージョンアップのやりかた - 日々常々](https://irof.hateblo.jp/entry/2021/12/10/180215)
- [Log4J2 Vulnerability and Spring Boot](https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot)

- [Log4jで話題になったWAFの回避/難読化とは何か - WAF Tech Blog ｜ クラウド型 WAFサービス Scutum 【スキュータム】](https://www.scutum.jp/information/waf_tech_blog/2021/12/waf-blog-081.html)
- [【重要】Apache Log4j ライブラリの脆弱性における当社サービスへの影響について | さくらインターネット](https://www.sakura.ad.jp/information/announcements/2021/12/17/1968208792/)
- [世界中を揺るがしたJavaライブラリの脆弱性・Log4Shellのネタ画像をまとめた「log4j memes」 - GIGAZINE](https://gigazine.net/news/20211216-log4j-memes/)
- [Log4Shell Update: Severity Upgraded 3.7 -> 9.0 for Second log4j Vulnerability (CVE-2021-45046) | LunaSec](https://www.lunasec.io/docs/blog/log4j-zero-day-severity-of-cve-2021-45046-increased/)
- [「Log4j」の脆弱性によるセキュリティ危機には、さらに深刻な“第2波”がやってくる | WIRED.jp](https://wired.jp/2021/12/18/log4j-log4shell-vulnerability-ransomware-second-wave/) : ransomware がこの脆弱性を利用してくるのはこれから，という予想
- [Log4jの脆弱性を検証、NTTデータ先端技術がレポートを発表　～「脆弱性の悪用が可能なことを確認」 - アイマガジン｜i Magazine｜IS magazine](https://www.imagazine.co.jp/log4j-8-nttdata/)
- [Apache Log4j の脆弱性に関連する New Relic のお客様向けセキュリティ案内 | New Relic](https://newrelic.com/jp/blog/nerdlog/security-guidance-for-log4j)

[CVE-2021-44228]: https://nvd.nist.gov/vuln/detail/CVE-2021-44228
[CVE-2021-45046]: https://nvd.nist.gov/vuln/detail/CVE-2021-45046
[CVE-2021-45105]: https://nvd.nist.gov/vuln/detail/CVE-2021-45105
[Logback]: http://logback.qos.ch/

## 参考図書

{{% review-paapi "B07CKHR8C1" %}} <!-- Spring Data JPAプログラミング入門 -->
{{% review-paapi "4621303252" %}} <!-- Effective Java 第3版 -->
{{% review-paapi "B0893LQ5KY" %}} <!-- Spring Boot 2 入門 -->
{{% review-paapi "B09HK66P5X" %}} <!-- Java言語で学ぶデザインパターン入門第3版 -->
