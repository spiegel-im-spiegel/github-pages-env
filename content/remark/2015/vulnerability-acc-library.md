+++
date = "2015-11-18T20:29:21+09:00"
description = "なお，今回のケースは Java 以外にも広がるかもしれないので，類似情報に注意しておいた方がいいだろう。"
draft = false
tags = ["security", "vulnerability", "de-serialize", "java"]
title = "Apache Commons Collections ライブラリの非直列化処理に脆弱性"

[author]
  avatar = "/images/avatar.jpg"
  facebook = "spiegel.im.spiegel"
  flattr = "spiegel"
  github = "spiegel-im-spiegel"
  instagram = "spiegel_2007"
  license = "by-sa"
  linkedin = "spiegelimspiegel"
  medium = "@spiegel"
  name = "Spiegel"
  twitter = "spiegel_2007"
  url = "http://www.baldanders.info/spiegel/profile/"
+++

1週間以上前の話で，なんだか今更なんだけど，全く仕事に絡んでないこともないので，覚え書きの形で残しておく。
なお，今回のケースは Java 以外にも広がるかもしれないので，類似情報に注意しておいた方がいいだろう。

## 脆弱性の内容

発端はこれ。

{{< fig-quote title="Apache Commons Collections ライブラリのデシリアライズ処理に脆弱性" link="http://jvn.jp/vu/JVNVU94276522/" >}}
<q>2015年1月に開催された AppSec California 2015 において、<a href="http://frohoff.github.io/appseccali-marshalling-pickles/">Gabriel Lawrence 氏と Chris Frohoff 氏</a>は、信頼できないデータをデシリアライズしてしまう脆弱性について講演し、任意のコードを実行可能であることを示しました。</q>
{{< /fig-quote >}}

更に両氏は今月になって，この脆弱性が Apache Commons Collections ライブラリに存在し，非直列化（de-serialize）に `InvokerTransformer` クラスを使用している場合，任意のコードを実行される可能性があることを指摘した。

## 影響を受ける製品

- Apache Commons Collections ライブラリのバージョン 3.2.1 および 4.0 が影響を受ける
- ACC ライブラリを利用する WebLogic, WebSphere, JBoss, Jenkins, OpenNMS 等の製品が影響を受ける

さらに

- Groovy や Spring の一部バージョンにも同様の脆弱性がある
- Java 以外にも Python, Ruby などで書かれたアプリケーションやライブラリにも同様の脆弱性がある可能性が指摘されている

### 影響度（CVSS）

CVSS 基本評価値 7.5 (AV:N/AC:L/Au:N/C:P/I:P/A:P)

{{% fig-gen title="CVSSv2 基本評価値" %}}
| 基本評価基準                            | 評価値            |
|----------------------------------------:|:------------------|
| 攻撃元区分（AV）                        | ネットワーク（N） |
| 攻撃条件の複雑さ（AC）                  | 低 (L)            |
| 攻撃前の認証要否（Au）                  | 不要（N）         |
| 情報漏えいの可能性（機密性への影響, C） | 部分的（P）       |
| 情報改ざんの可能性（完全性への影響, I） | 部分的（P）       |
| 業務停止の可能性（可用性への影響, A）   | 部分的（P）       |
{{% /fig-gen %}}

CVSS については[デモページ](http://www.baldanders.info/spiegel/archive/cvss/cvss2.html)を参照のこと。

## 対策・回避策

この脆弱性の完全な対策は存在しない。
`InvokerTransformer` クラスを無効にするだけでは完全な対策とは言えない。

{{< fig-quote title="Apache Commons statement to widespread Java object de-serialisation vulnerability" link="https://blogs.apache.org/foundation/entry/apache_commons_statement_to_widespread" lang="en" >}}
<q>However, to be clear: this is not the only known and especially not unknown useable gadget. So replacing your installations with a hardened version of Apache Commons Collections will not make your application resist this vulnerability.</q>
{{< /fig-quote >}}

回避策としては以下のとおり。

- ファイアウォールやファイルシステムのアクセス制御を活用する
- アプリケーションの設計を見直す

{{< fig-quote title="Apache Commons Collections ライブラリのデシリアライズ処理に脆弱性" link="http://jvn.jp/vu/JVNVU94276522/" >}}
<q>Apache Commons Collections ライブラリの対策版リリースの準備が進められています。しかし、現状提案されているパッチはシリアライズ機能をデフォルトで無効にするだけのものです。当該ライブラリのシリアライズ機能が必要な場合には、この機能を有効にするコードを追加するとともに、安全にデシリアライズするようアプリケーションの設計を見直す必要があります。</q>
{{< /fig-quote >}}

### ベンダの対応

- WebLogic : [回避策](https://support.oracle.com/rs?type=doc&id=2076338.1)あり（パッチ準備中）
- WebSphere : 最新版あり
- JBoss : 最新版あり（一部パッチ準備中），危険なクラスを削除
- Jenkins : 最新版あり
- OpenNMS : Port 1099 の遮断で回避
- Groovy : 最新版あり
- Spring : 最新版あり

## 参考

- [JVNVU#94276522: Apache Commons Collections ライブラリのデシリアライズ処理に脆弱性](http://jvn.jp/vu/JVNVU94276522/)
- [Vulnerability Note VU#576313 - Apache Commons Collections Java library insecurely deserializes data](http://www.kb.cert.org/vuls/id/576313)
- [AppSecCali 2015: Marshalling Pickles by frohoff](http://frohoff.github.io/appseccali-marshalling-pickles/)
- [What Do WebLogic, WebSphere, JBoss, Jenkins, OpenNMS, and Your Application Have in Common? This Vulnerability.](http://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
- [Apache Commons statement to widespread Java object de-serialisation vulnerability : The Apache Software Foundation Blog](https://blogs.apache.org/foundation/entry/apache_commons_statement_to_widespread)
- [主要Javaアプリケーションサーバに影響するJavaライブラリの脆弱性を正しく理解する | トレンドマイクロ セキュリティブログ](http://blog.trendmicro.co.jp/archives/12577)
- [Javaライブラリに脆弱性、主要ミドルウェア全てに影響 - ITmedia エンタープライズ](http://www.itmedia.co.jp/enterprise/articles/1511/10/news053.html)
- [Javaライブラリにリモートコード実行の脆弱性--JBoss、WebSphere、WebLogicなどに影響 - ZDNet Japan](http://japan.zdnet.com/article/35073223/)
- [Apache Commonsのcollectionsの脆弱性に関連するリンク集をまとめてみた。 - piyolog](http://d.hatena.ne.jp/Kango/20151110/1447175137)
- [commons-collectionsのInvokerTransformer脆弱性について - R42日記](http://takahashikzn.root42.jp/entry/2015/11/10/155319)
- [SpringとGroovyにも直列化オブジェクト脆弱性 - R42日記](http://takahashikzn.root42.jp/entry/2015/11/12/031449)
