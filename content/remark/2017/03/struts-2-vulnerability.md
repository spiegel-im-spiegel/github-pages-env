+++
draft = false
date = "2017-03-09T20:07:20+09:00"
update = "2017-03-23T10:09:49+09:00"
title = "Struts 2 の脆弱性について"
tags = ["security", "vulnerability", "java"]
description = "あちこちで騒がれてるみたいなので簡単に紹介する。"

[author]
  flattr = "spiegel"
  url = "http://www.baldanders.info/spiegel/profile/"
  name = "Spiegel"
  linkedin = "spiegelimspiegel"
  facebook = "spiegel.im.spiegel"
  tumblr = "spiegel-im-spiegel"
  flickr = "spiegel"
  twitter = "spiegel_2007"
  avatar = "/images/avatar.jpg"
  license = "by-sa"
  github = "spiegel-im-spiegel"
  instagram = "spiegel_2007"
+++

最近は Web や Java 絡みの仕事をしてないのでスルーしようかと思ったけど，あちこちで騒がれてるみたいなので簡単に紹介する。

- [S2-045 - Apache Struts 2 Documentation - Apache Software Foundation](https://cwiki.apache.org/confluence/display/WW/S2-045)
- [更新：Apache Struts2 の脆弱性対策について(CVE-2017-5638)(S2-045)(S2-046)：IPA 独立行政法人 情報処理推進機構](http://www.ipa.go.jp/security/ciadr/vul/20170308-struts.html)
- [Apache Struts 2 の脆弱性 (S2-045) に関する注意喚起](https://www.jpcert.or.jp/at/2017/at170009.html)

## 脆弱性の内容

{{< fig-quote title="Apache Struts2 の脆弱性対策について(CVE-2017-5638)(S2-045)" link="http://www.ipa.go.jp/security/ciadr/vul/20170308-struts.html" >}}
<q>Apache Struts 2 には、「Jakarta Multipart parser」のファイルアップロード処理に起因する、リモートで任意のコードが実行される脆弱性(CVE-2017-5638)が存在します。<br>
本脆弱性が悪用された場合、遠隔の第三者によって、サーバ上で任意のコードを実行される可能性があります。</q>
{{< /fig-quote >}}

既に攻撃コード（Proof of Concept; PoC）が存在し実際に被害が出ているようだ。

## 影響度（CVSS）

「[JVNVU#93610402: Apache Struts2 に任意のコードが実行可能な脆弱性](http://jvn.jp/vu/JVNVU93610402/)」より

**CVSSv3 基本評価値 7.3 (CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:L)**

| 基本評価基準                            | 評価値            |
|----------------------------------------:|:------------------|
| 攻撃元区分（AV）                        | ネットワーク（N） |
| 攻撃条件の複雑さ（AC）                  | 低（L）           |
| 必要な特権レベル（PR）                  | 不要（N）         |
| ユーザ関与レベル（UI）                  | 不要（N）         |
| スコープ（S）                           | 変更なし（U）     |
| 情報漏えいの可能性（機密性への影響, C） | 低（L）           |
| 情報改ざんの可能性（完全性への影響, I） | 低（L）           |
| 業務停止の可能性（可用性への影響, A）   | 低（L）           |

CVSS については[解説ページ]({{< relref "remark/2015/cvss-v3-metrics-in-jvn.md" >}})を参照のこと。

## 影響を受ける製品

- Apache Struts 2.3.5 から 2.3.31
- Apache Struts 2.5 から 2.5.10

Struts 1 に影響があるかどうかは不明（公開されている PoC では問題ないようだ？）。

## 対策・回避策

対策としては以下のバージョンにアップデートする。

- Apache Struts 2.3.32 以降
- Apache Struts 2.5.10.1 以降

回避策として以下も紹介されている。

{{< fig-quote title="CVE-2017-5638 - 脆弱性調査レポート" link="https://www.softbanktech.jp/information/2017/20170308-01/" >}}
<q>ただちにアップグレードすることが困難である場合、「Content-Type」のバリデーションを行い、”multipart/form-data”と一致しないリクエストを破棄するサーブレットフィルターを実装することにより問題を回避することが可能です。</q>
{{< /fig-quote >}}

{{< fig-quote title="Apache Struts 2 の脆弱性 (S2-045) に関する注意喚起" link="https://www.jpcert.or.jp/at/2017/at170009.html" >}}
<q>また、Apache Software Foundation は、パーサをデフォルトの Jakarta Multipart parser (JakartaMultiPartRequest) から変更することも対策として呼びかけています。速やかなアップデートが難しい場合は、本対策の適用をご検討ください。</q>
{{< /fig-quote >}}

**（追記）** 代替パーサもこの脆弱性の影響を受けることが判明している。
ただし [S2-046](https://struts.apache.org/docs/s2-046.html) で修正版が出ているようだ。

## ブックマーク

- [CVE-2017-5638 - 脆弱性調査レポート | ソフトバンク・テクノロジー](https://www.softbanktech.jp/information/2017/20170308-01/)
- [Struts2の脆弱性 CVE-2017-5638 (S2-045)についてまとめてみた - piyolog](http://d.hatena.ne.jp/Kango/20170307/1488907259)
- [Apache Struts 2に脆弱性報告--既に攻撃発生も - ZDNet Japan](https://japan.zdnet.com/article/35097780/)
- [Apache Struts2の脆弱性（CVE-2017-5638）を検証してみた - とある診断員の備忘録](http://tigerszk.hatenablog.com/entry/2017/03/08/063334)
- [2017年3月に発生したApache Struts 2で稼働していたとみられるWebサイトへの不正アクセスについてまとめてみた - piyolog](http://d.hatena.ne.jp/Kango/20170311/1489253880)
    - [都税支払いサイトからカード情報6万件超が流出か - ITmedia ビジネスオンライン](http://www.itmedia.co.jp/business/articles/1703/10/news133.html)
    - [高木浩光＠自宅の日記 - 「都税クレジットカードお支払サイト」流出事件の責任は誰がとるのか](http://takagi-hiromitsu.jp/diary/20170310.html) : 何気に最悪の事故に発展するかもしれない
    - {{< pdf-file title="当社Webサイトへの不正アクセスによるコンテンツの改ざんおよびお客さまＥメールアドレス等の流出の可能性について" link="http://www.okiden.co.jp/shared/pdf/news_release/2016/170315.pdf" >}}
- [GMO社が被害を受けたStruts 2（CVE-2017-5638）問題で我々は何を学ぶべきか？ - Qiita](http://qiita.com/gakuri/items/f70cf6c10fbb846335d5)
- [ニュース解説 - 猛威振るうStruts2脆弱性への攻撃、どうすれば防げたか：ITpro](http://itpro.nikkeibp.co.jp/atcl/column/14/346926/032100893/)
