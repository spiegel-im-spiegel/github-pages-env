+++
title = "“Philosophers” を Go で解く（問題編）"
date =  "2025-09-02T15:05:52+09:00"
description = "ルールの説明について"
image = "/images/attention/go-logo_blue.png"
tags = [ "programming", "golang", "concurrency", "games" ]
pageType = "text"

[scripts]
  mathjax = true
  mermaidjs = false
+++

先日書いた[読書感想文]({{< ref "/remark/2025/08/learn-concurrent-programming-with-go.md" >}} "『Go言語で学ぶ並行プログラミング』は必読書である（夏の読書感想文2）")の最後の方で「[食事する哲学者の問題](https://ja.wikipedia.org/wiki/%E9%A3%9F%E4%BA%8B%E3%81%99%E3%82%8B%E5%93%B2%E5%AD%A6%E8%80%85%E3%81%AE%E5%95%8F%E9%A1%8C "食事する哲学者の問題 - Wikipedia")」を紹介したが，今回から数回に渡ってこの問題を [Go] で解く記事を書いてみる。

読書会で教えて頂いたテキストは “Philosophers - I never thought philosophy would be so deadly” というのだが，ググっても（フリーで使えそうな）オリジナルっぽい文書が見つからないので，問題について説明するところから始めたいと思う（今回のために多少アレンジしている。あしからず）。

## 基本ルール

まず，基本のルールについて。

{{< div-box type="markdown" >}}
1. 円卓に2人以上の哲学者が座っている
2. 哲学者は「食べる」→「寝る」→「考える」のローテーションを逐次繰り返す。哲学者間で行動の差異はない
   - 「食べる」間は「寝る」「考える」を行わない
   - 「寝る」間は「食べる」「考える」を行わない
   - 「考える」間は「食べる」「寝る」を行わない
3. 円卓の中央には大きなスパゲッティボールがあり，哲学者は食事の際はそれぞれボールからスパゲッティを取って食べる
4. スパゲッティを取って食べるためのフォークは哲学者の人数分だけあり，各哲学者から見て左右に1本ずつ配置されている
5. 食事の際はフォークが必ず2本必要。各哲学者は左右にある2本のフォークを取って食事を行う（他のフォークは使わない）
   - フォークを使っている間は他の哲学者は同じフォークを使えない
   - 食事が終わったらフォークを戻し，他の哲学者が使えるようにする
6. 哲学者はお互いの状態を知らず，コミュニケーションすることもない
7. 哲学者は一定時間食事をしないと餓死する
{{< /div-box >}}

スパゲッティ・フォーク・哲学者の配置を簡単に図示してみる（図は哲学者が5人の場合）。

{{< fig-img-quote src="./image-20180407011914220.png" title="“SE 350 Textbook Notes - Sentences” (CC-BY-NC)" link="https://ivy-zhou.github.io/notes/2018/02/15/se-350-textbook-notes.html" lang="en" width="1048" >}}

同じフォークを哲学者同士で使い回すんかい！ とか，スパゲッティの補充はどうするの？ とか生々しい話はいったん考えない。
まぁ，哲学者って ~~頭おかしい~~ 変わり者が多そうだし（笑）

このルール下で餓死者を出さずに全員が一定回数以上食事を行うにはどうすればいいか，という問いである。
このシミュレーションを [Go] で組んでみよう，というわけだ。

## パラメータおよび終了条件

シミュレーションに必要な各種パラメータを以下に示す。

| シンボル | 型 | 説明 |
| :--- | :---: | :--- |
| `nmPhilos` | `int` | 哲学者およびフォークの数（$\ge 2$） |
| `tmDie` | `int` | 餓死するまでの時間（$\gt 0\\,\mathrm{ms}$） |
| `tmEat` | `int` | 「食べる」時間（$\gt 0\\,\mathrm{ms}$） |
| `tmSleep` | `int` | 「寝る」時間（$\gt 0\\,\mathrm{ms}$） |
| `tmThink` | `int` | 「考える」時間（$\gt 0\\,\mathrm{ms}$） |
| `nmEat` | `int` | 各哲学者が最低限食事を行う回数（$\ge 0$） |

シミュレーションの終了条件は以下の通り：

- 哲学者はシミュレーション開始または食事を開始してから `tmDie` ミリ秒以内に次の食事を始めないと餓死する
- 哲学者の誰か1人が餓死した場合または全員が `nmEat` 回以上食事を行った場合はシミュレーションを終了する
  - デッドロックを検出した場合は餓死確定とみなしてシミュレーションを終了する（[Go] ランタイムの標準機能[^dl1]）
  - `nmEat` が 0 の場合は誰かが餓死しない限り処理を継続する

[^dl1]: [Go] ランタイムは全ての goroutine が停止するとデッドロックとみなしてプロセスを終了する。なお `Sleep` 等のタイマーやネットワーク通信などの一時停止状態は除く。

## その他 注意事項およびヒント

- パラメータを含め，変数をグローバル変数として配置しない
- 以下のイベントに対してログを出力する。タイムスタンプはミリ秒単位
  - 哲学者 X がフォークを持った
  - 哲学者 X がフォークを戻した
  - 哲学者 X が「食べる」を開始した
  - 哲学者 X が「寝る」を開始した
  - 哲学者 X が「考える」を開始した
  - 哲学者 X が餓死した
- ライブラリは [Go] の標準パッケージのみ使用する。サードパーティ製のパッケージは使用しない
- 哲学者の行動は goroutine による並行処理として実装する
- フォークは哲学者間の共有資源とみなし mutex を使って排他制御を行う[^sem1]
- スパゲッティは無尽蔵かつ専有不可であるとみなし，排他制御の対象としない

[^sem1]: [Go] の標準パッケージでは semaphore は（ユーザが利用できる形では）提供されていない。事実上の準標準パッケージとしては [`golang.org/x/sync/semaphore`] が重み付きセマフォ（weighted semaphore）として公開されている。

こんなところかな。
さぁ，みんなで考えよう！（続く）

[Go]: https://go.dev/
[`golang.org/x/sync/semaphore`]: https://pkg.go.dev/golang.org/x/sync/semaphore "semaphore package - golang.org/x/sync/semaphore - Go Packages"

## 参考図書

{{% review-paapi "B0DNYMMBBQ" %}} <!-- Go言語で学ぶ並行プログラミング -->
{{% review-paapi "4873118468" %}} <!-- Go言語による並行処理 -->
{{% review-paapi "4621300253" %}} <!-- プログラミング言語Go -->
{{% review-paapi "B0CFL1DK8Q" %}} <!-- Go言語 100Tips -->
{{% review-paapi "4908686122" %}} <!-- Goならわかるシステムプログラミング 第2版 -->
